# Rendered: <%= Time.now.utc %>

# Redirect to WWW on production
<% if app_stage == "production" %>
server {
	listen 8080;

	# Redirect to www. if on production
	server_name <%= app_domain %>;
	rewrite ^ $scheme://www.<%= app_domain %>$request_uri permanent;
}
<% end %>

server {

	##################################
	#                                #
	#        Default settings        #
	#                                #
	##################################

	# Error Logging
	error_log /var/log/nginx/error.log notice;
	# rewrite_log on;

	# Set the port
	listen 8080;

	# Where are we located? What should we load by default?
	root <%= app_deploy_to %>/current/public;
	index index.html index.htm;

	# What's our domain name?
	<% if app_stage == "production" %>
	server_name www.<%= app_domain %>;
	<% else %>
	server_name <%= app_domain %>;
	<% end %>

	# Avoid sendfile issues with sending stale files
	# More: <http://www.vanpattenmedia.com/2012/a-tale-of-stale-content/>
	sendfile off;

	location / {
		try_files $uri $uri/ /index.html last;
	}


	###################
	#      Fonts      #
	###################

	location ~* \.(?:eot|ttf|otf|woff|svg)$ {
		
		# Caching
		<% if app_stage != "dev" %>
		
		expires 120d;
		add_header Pragma public;
		add_header Cache-Control "public, must-revalidate, proxy-revalidate";
		
		<% else %>
		
		expires 0m;
		add_header Pragma no-cache;
		add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
		
		<% end %>
		
	}


	###################
	#      Images     #
	###################

	location ~* \.(?:ico|gif|jpe?g|png)$ {
		
		# Caching
		<% if app_stage != "dev" %>
		
		expires 7d;
		add_header Pragma public;
		add_header Cache-Control "public, must-revalidate, proxy-revalidate";
		
		<% else %>
		
		expires 0m;
		add_header Pragma no-cache;
		add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
		
		<% end %>
		
	}


	###################
	#     CSS & JS    #
	###################

	location ~* \.(?:css|js)$ {
		
		# Caching
		<% if app_stage != "dev" %>
		
		expires 2d;
		add_header Pragma public;
		add_header Cache-Control "public, must-revalidate, proxy-revalidate";
		
		<% else %>
		
		expires 0m;
		add_header Pragma no-cache;
		add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
		
		<% end %>
		
	}


	###################
	#  Error handling #
	###################

	# redirect server error pages to the static page /50x.html
	# error_page 404 /404.html;
	# error_page 500 502 503 504 /50x.html;
	# location = /50x.html {
	# 	root /usr/share/nginx/www;
	# }	

	# Don't log when robots or favicon is accessed or 404'd
	location = /favicon.ico { access_log off; log_not_found off; }
	
	# Prevents dotfiles from being served
	location ~ /\.          { access_log off; log_not_found off; deny all; }

}


# SSL server

server {

	##################################
	#                                #
	#        Default settings        #
	#                                #
	##################################

	# Error Logging
	error_log /var/log/nginx/error.log notice;
	# rewrite_log on;

	# Set the port
	listen 443 ssl;
	# SSL settings are set globally for all servers in the Nginx global configuration

	# Where are we located? What should we load by default?
	root <%= app_deploy_to %>/current/public;
	index index.html index.htm;

	# What's our domain name?
	<% if app_stage == "production" %>
	server_name www.<%= app_domain %>;
	<% else %>
	server_name <%= app_domain %>;
	<% end %>

	# Avoid sendfile issues with sending stale files
	# More: <http://www.vanpattenmedia.com/2012/a-tale-of-stale-content/>
	sendfile off;

	location / {
		try_files $uri $uri/ /index.html last;
	}


	###################
	#      Fonts      #
	###################

	location ~* \.(?:eot|ttf|otf|woff|svg)$ {
		
		# Caching
		<% if app_stage != "dev" %>
		
		expires 120d;
		add_header Pragma public;
		add_header Cache-Control "public, must-revalidate, proxy-revalidate";
		
		<% else %>
		
		expires 0m;
		add_header Pragma no-cache;
		add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
		
		<% end %>
		
	}


	###################
	#      Images     #
	###################

	location ~* \.(?:ico|gif|jpe?g|png)$ {
		
		# Caching
		<% if app_stage != "dev" %>
		
		expires 7d;
		add_header Pragma public;
		add_header Cache-Control "public, must-revalidate, proxy-revalidate";
		
		<% else %>
		
		expires 0m;
		add_header Pragma no-cache;
		add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
		
		<% end %>
		
	}


	###################
	#     CSS & JS    #
	###################

	location ~* \.(?:css|js)$ {
		
		# Caching
		<% if app_stage != "dev" %>
		
		expires 2d;
		add_header Pragma public;
		add_header Cache-Control "public, must-revalidate, proxy-revalidate";
		
		<% else %>
		
		expires 0m;
		add_header Pragma no-cache;
		add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
		
		<% end %>
		
	}


	###################
	#  Error handling #
	###################

	# redirect server error pages to the static page /50x.html
	# error_page 404 /404.html;
	# error_page 500 502 503 504 /50x.html;
	# location = /50x.html {
	#       root /usr/share/nginx/www;
	# }

	# Don't log when robots or favicon is accessed or 404'd
	location = /favicon.ico { access_log off; log_not_found off; }
	
	# Prevents dotfiles from being served
	location ~ /\.          { access_log off; log_not_found off; deny all; }

}